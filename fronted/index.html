<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Simple Bank</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="./abi.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        #balanceDisplay { font-size: 24px; color: #28a745; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h1>ğŸ¦ è€Gçš„é“¶è¡Œ</h1>
        
        <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š 1. è¿æ¥é’±åŒ…</button>
        <p id="accountArea">åœ°å€: æœªè¿æ¥</p>
        
        <hr>

        <hr>
        <h3>æˆ‘è¦å­˜é’±</h3>
        <input type="text" id="depositAmount" placeholder="0.1" /> 
        <button onclick="depositMoney()">ğŸ’¸ å­˜å…¥é“¶è¡Œ</button>
        <hr>
        
        <h3>æˆ‘çš„å­˜æ¬¾</h3>
        <div id="balanceDisplay">0.0 ETH</div>
        <button onclick="getMyBalance()">ğŸ’° 2. åˆ·æ–°ä½™é¢</button>

        <hr>
        <h3>æˆ‘è¦å–æ¬¾</h3>
        <input type="text" id="withdrawAmount" placeholder="æƒ³å–å¤šå°‘ï¼Ÿ" /> 
        <button onclick="withdrawMoney()" style="background-color: #dc3545;">ğŸ§ å–æ¬¾è·‘è·¯</button>
        <hr>
    </div>

    <script>
        // ğŸ”´ å¿…æ”¹é¡¹ï¼šæŠŠä½ çš„ Bank åˆçº¦åœ°å€å¡«åœ¨è¿™é‡Œï¼
        const contractAddress = "0x9CE92cB6A7D24E480496f7EE54A296641c517373"; // <--- å¡«ä½ çš„åœ°å€ï¼Œä¿ç•™å¼•å·

        let provider;
        let signer;
        let bankContract;
        let userAddress;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });//awaitå’Œasyncé…åˆä½¿ç”¨ï¼Œç­‰å¾…ç”¨æˆ·æˆæƒï¼Œasyncå‡½æ•°åœ¨awaitæš‚åœæ‰§è¡Œç­‰å¾…ç”¨æˆ·æ“ä½œï¼Œå¦‚æœ¬ä¾‹ï¼Œå½“requestæ‹¿åˆ°ç”¨æˆ·çš„è´¦æˆ·æ•°ç»„åæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
                    userAddress = accounts[0];//accountsä¸ºå•¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Ÿç­”ï¼šå› ä¸ºç”¨æˆ·å¯èƒ½æœ‰å¤šä¸ªè´¦æˆ·
                    
                    document.getElementById('connectBtn').innerText = "å·²è¿æ¥";//è¿™ä¸€æ­¥æ“ä½œæ˜¯æŠŠæŒ‰é’®æ–‡å­—æ”¹æˆâ€œå·²è¿æ¥â€
                    document.getElementById('accountArea').innerText = "åœ°å€: " + userAddress.substring(0, 6) + "..." + userAddress.substring(38);//substringæ˜¯å­—ç¬¦ä¸²æˆªå–å‡½æ•°ï¼Œè¿™é‡Œæ˜¯æŠŠä¸­é—´éƒ¨åˆ†çœç•¥æ‰ï¼Œåªæ˜¾ç¤ºå‰6ä½å’Œå4ä½

                    // --- å…³é”® Web3 åˆå§‹åŒ– ---
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner(); // ç­¾åè€…ï¼ˆå¦‚æœæ˜¯å†™æ“ä½œï¼Œéœ€è¦å®ƒï¼‰

                    // ã€æ ¸å¿ƒæ¦‚å¿µã€‘æ„å»ºåˆçº¦å¯¹è±¡ï¼šåœ°å€ + ABI + äº¤äº’æ–¹å¼(Provider)
                    // è¿™è¡Œä»£ç ä¹‹åï¼ŒbankContract å°±æ˜¯ä½ åœ¨ JS é‡Œçš„â€œé“¶è¡Œç»ç†â€
                    bankContract = new ethers.Contract(contractAddress, BankABI, provider);
                    
                    console.log("åˆçº¦å¯¹è±¡åˆ›å»ºæˆåŠŸï¼", bankContract);

                } catch (error) {
                    console.error(error);
                    alert("è¿æ¥å¤±è´¥ï¼Œè¯·çœ‹æ§åˆ¶å°");
                }
            } else {
                alert("è¯·å®‰è£… MetaMask");
            }
        }

        async function getMyBalance() {
            if (!bankContract) return alert("è¯·å…ˆè¿æ¥é’±åŒ…ï¼");

            try {
                // 1. è°ƒç”¨åˆçº¦çš„ balance æ˜ å°„
                // åœ¨ Solidity é‡Œæ˜¯ mapping(address => uint)ï¼Œåœ¨ JS é‡Œå°±æ˜¯ä¸ªå‡½æ•°ï¼Œä¼ å…¥åœ°å€
                console.log("æ­£åœ¨æŸ¥è¯¢åœ°å€:", userAddress);
                
                // ã€æ³¨æ„ã€‘è¿™é‡Œå¿…é¡»ç”¨ awaitï¼Œå› ä¸ºå»é“¾ä¸ŠæŸ¥æ•°æ®éœ€è¦æ—¶é—´
                const balanceWei = await bankContract.balance(userAddress);
                
                console.log("åŸå§‹æ•°æ® (Wei):", balanceWei.toString());

                // 2. æ ¼å¼åŒ–ï¼šæŠŠ Wei å˜æˆ ETH
                // é“¾ä¸Šè¿”å›çš„æ˜¯å·¨å¤§çš„æ•´æ•° (1 ETH = 10^18 Wei)ï¼Œäººçœ‹ä¸æ‡‚ï¼Œè¦è½¬æ¢
                const balanceEth = ethers.utils.formatEther(balanceWei);

                // 3. æ›´æ–°ç½‘é¡µ
                document.getElementById('balanceDisplay').innerText = balanceEth + " ETH";
                
            } catch (error) {
                console.error("æŸ¥è¯¢å‡ºé”™:", error);
                alert("æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€… ABI æ˜¯å¦åŒ¹é…");
            }
        }

        async function depositMoney() {
            // 1. è·å–ç”¨æˆ·è¾“å…¥çš„é‡‘é¢
            const amountStr = document.getElementById('depositAmount').value;//depositAmountæ˜¯è¾“å…¥æ¡†çš„idï¼Œvalueæ˜¯è·å–è¾“å…¥æ¡†çš„å€¼
            if (!amountStr) return alert("è€å“¥ï¼Œå¡«ä¸ªæ•°å­—å•Šï¼");

            try {
                console.log("æ­£åœ¨å‡†å¤‡å­˜é’±:", amountStr, "ETH");

                // --- æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼šProvider vs Signer ---
                // ä¹‹å‰æŸ¥ä½™é¢ç”¨çš„æ˜¯ provider (åªè¯»)ã€‚
                // ç°åœ¨è¦å­˜é’±ï¼Œæ¶‰åŠèµ„äº§å˜åŠ¨ï¼Œå¿…é¡»ç”¨ signer (ç­¾åè€…)ã€‚
                
                // provider æ˜¯æˆ‘ä»¬åœ¨ connectWallet é‡Œåˆå§‹åŒ–çš„
                if (!provider) return alert("å…ˆè¿æ¥é’±åŒ…ï¼");
                
                // ã€å…³é”®ã€‘ä» provider é‡Œè·å– signer
                // è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼šè®© MetaMask å‡†å¤‡å¥½è®©ç”¨æˆ·ç­¾å­—
                const signer = provider.getSigner();

                // ã€å…³é”®ã€‘åˆ›å»ºä¸€ä¸ªâ€œå¯å†™â€çš„åˆçº¦å¯¹è±¡
                // ä¹‹å‰çš„ bankContract å¯èƒ½æ˜¯åªè¯»çš„ï¼ˆå¦‚æœå®ƒæ˜¯ç”¨ provider åˆ›å»ºçš„ï¼‰
                // ç°åœ¨æˆ‘ä»¬ç”¨ signer é‡æ–°è¿ä¸€ä¸‹åˆçº¦
                const bankWithSigner = bankContract.connect(signer);//connectæ˜¯ethers.jsé‡Œçš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥è¿æ¥ä¸€ä¸ªæ–°çš„ç­¾åè€…ï¼Œæ­¤æ—¶çš„é“¶è¡Œç»ç†æ˜¯bankWithSigner

                // 2. é‡‘é¢è½¬æ¢ï¼šäººçœ‹çš„ ETH -> é“¾ä¸Šç”¨çš„ Wei
                // parseEther æ„æ€æ˜¯ï¼šæŠŠ "0.1" å˜æˆ 100000000000000000 (18ä¸ª0)
                const amountWei = ethers.utils.parseEther(amountStr);

                // 3. å‘èµ·äº¤æ˜“
                // è°ƒç”¨åˆçº¦çš„ deposit å‡½æ•°
                // ã€æ³¨æ„ã€‘å› ä¸º deposit æ˜¯ payable çš„ï¼Œæ‰€ä»¥è¦åœ¨ overrides é‡Œå¸¦ä¸Š value
                console.log("ç­‰å¾…é’±åŒ…ç¡®è®¤...");
                const tx = await bankWithSigner.deposit({ value: amountWei });

                console.log("äº¤æ˜“å·²å‘é€ï¼å“ˆå¸Œ:", tx.hash);
                alert("äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ä¸Šé“¾... (è¯·ä¸è¦å…³é—­é¡µé¢)");

                // 4. ç­‰å¾…äº¤æ˜“è¢«çŸ¿å·¥æ‰“åŒ…
                // wait() æ˜¯ ethers.js æœ€ä¼˜é›…çš„åŠŸèƒ½ï¼Œå®ƒä¼šä¸€ç›´ç­‰åˆ°é“¾ä¸Šç¡®è®¤äº†æ‰å¾€ä¸‹èµ°
                await tx.wait();

                console.log("äº¤æ˜“æˆåŠŸï¼");
                alert("å­˜é’±æˆåŠŸï¼å¿«å»åˆ·æ–°ä½™é¢çœ‹çœ‹ï¼");

                // è‡ªåŠ¨åˆ·æ–°ä¸€ä¸‹ä½™é¢
                getMyBalance();

            } catch (error) {
                console.error("å­˜é’±å¤±è´¥:", error);
                alert("å­˜é’±å¤±è´¥ï¼Œè¯¦è§æ§åˆ¶å°");
            }
        }

    async function withdrawMoney() {
        const amountStr = document.getElementById('withdrawAmount').value;
        if (!amountStr) return alert("è¦å–å¤šå°‘é’±ï¼Ÿå¡«ä¸ªæ•°å­—ï¼");

        try {
            console.log("å‡†å¤‡å–æ¬¾:", amountStr, "ETH");

            if (!provider) return alert("å…ˆè¿æ¥é’±åŒ…ï¼");
            
            // 1. ä¾ç„¶éœ€è¦ Signerï¼Œå› ä¸ºè¿™ä¼šæ”¹å˜é“¾ä¸Šæ•°æ®ï¼ˆæ”¹è´¦æœ¬ï¼‰
            const signer = provider.getSigner();//ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦é‡æ–°è·å–signerï¼Ÿç­”ï¼šå› ä¸ºæ¯æ¬¡è°ƒç”¨getSigner()éƒ½ä¼šè¿”å›å½“å‰è¿æ¥çš„é’±åŒ…çš„ç­¾åè€…å¯¹è±¡ï¼Œç¡®ä¿æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ç­¾åè€…å®ä¾‹ã€‚
            const bankWithSigner = bankContract.connect(signer);

            // 2. è½¬æ¢é‡‘é¢
            const amountWei = ethers.utils.parseEther(amountStr);

            // 3. è°ƒç”¨åˆçº¦
            // ã€æ³¨æ„åŒºåˆ«ã€‘
            // å­˜æ¬¾æ˜¯: .deposit({ value: amountWei })  <- é’±å¤¹åœ¨ä¿¡å°é‡Œ
            // å–æ¬¾æ˜¯: .withdraw(amountWei)            <- é’±å†™åœ¨ç”³è¯·å•ä¸Š(å‚æ•°)
            console.log("ç­‰å¾…é’±åŒ…ç¡®è®¤...");
            const tx = await bankWithSigner.withdraw(amountWei);

            console.log("å–æ¬¾è¯·æ±‚å·²å‘é€:", tx.hash);
            alert("æ­£åœ¨å–æ¬¾... è¯·ç­‰å¾…ä¸Šé“¾");

            await tx.wait();

            console.log("å–æ¬¾æˆåŠŸï¼");
            alert("é’±å·²å›åˆ°ä½ çš„é’±åŒ…ï¼");
            
            // åˆ·æ–°ä½™é¢
            getMyBalance();

        } catch (error) {
            console.error("å–æ¬¾å¤±è´¥:", error);
            // è¿™é‡Œå¯èƒ½ä¼šé‡åˆ° "moneyShortage" æŠ¥é”™ï¼Œå¦‚æœä½™é¢ä¸è¶³çš„è¯
            alert("å–æ¬¾å¤±è´¥ï¼å¯èƒ½æ˜¯ä½™é¢ä¸è¶³ï¼Œè¯¦è§æ§åˆ¶å°");
        }
    }    
    </script>
</body>
</html>